# roles/zabbix-server/templates/zabbix_server.conf.j2
LogFile=/var/log/zabbix/zabbix_server.log
LogFileSize=0
PidFile=/var/run/zabbix/zabbix_server.pid
SocketDir=/var/run/zabbix
DBHost=localhost
DBName=zabbix
DBUser=zabbix
DBPassword={{ mysql_zabbix_password | default('zabbix456!') }}
DBPort=3306
StartPollers=5
StartPollersUnreachable=1
StartTrappers=5
StartPingers=1
StartDiscoverers=1
StartHTTPPollers=1
StartTimers=1
StartEscalators=1
StartAlerters=3
HousekeepingFrequency=1
MaxHousekeeperDelete=5000
SenderFrequency=30
CacheSize=8M
CacheSizeUpdate=2M
StartDBSyncers=4
HistoryCacheSize=16M
HistoryIndexCacheSize=4M
TrendCacheSize=4M
ValueCacheSize=8M
Timeout=4
TrapperTimeout=300
UnreachablePeriod=45
UnavailableDelay=60
UnreachableDelay=15
AlertScriptsPath=/usr/lib/zabbix/alertscripts
ExternalScripts=/usr/lib/zabbix/externalscripts
LogSlowQueries=3000
TmpDir=/tmp
AllowRoot=0
User=zabbix
Include=/etc/zabbix/zabbix_server.conf.d/*.conf
SSLCertLocation=/usr/lib/zabbix/ssl/certs
SSLKeyLocation=/usr/lib/zabbix/ssl/keys
SSLCALocation=/usr/lib/zabbix/ssl/ssl_ca
LoadModulePath=/usr/lib/zabbix/modules
StatsAllowedIP=127.0.0.1

---

# roles/security/templates/jail.local.j2
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5
backend = auto
usedns = warn
logencoding = auto
enabled = false
filter = %(__name__)s
destemail = {{ admin_email }}
sender = fail2ban@{{ ansible_fqdn }}
mta = sendmail
protocol = tcp
chain = <known/chain>
port = 0:65535
fail2ban_agent = Fail2Ban/%(fail2ban_version)s

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 1800

[apache-auth]
enabled = true
port = http,https
filter = apache-auth
logpath = /var/log/apache2/*error.log
maxretry = 6

[apache-badbots]
enabled = true
port = http,https
filter = apache-badbots
logpath = /var/log/apache2/*access.log
bantime = 172800
maxretry = 1

[apache-noscript]
enabled = true
port = http,https
filter = apache-noscript
logpath = /var/log/apache2/*access.log
maxretry = 6

---

# roles/gdpr-compliance/templates/gdpr-cleanup.sh.j2
#!/bin/bash
# Script de nettoyage RGPD automatique
# Conforme aux exigences de rétention des données

LOG_FILE="/var/log/gdpr-cleanup.log"
RETENTION_DAYS={{ log_retention_days | default(90) }}

echo "$(date): Début du nettoyage RGPD" >> $LOG_FILE

# Nettoyage des logs anciens
find /var/log -name "*.log" -type f -mtime +$RETENTION_DAYS -exec rm -f {} \; 2>/dev/null
find /var/log -name "*.log.*.gz" -type f -mtime +$RETENTION_DAYS -exec rm -f {} \; 2>/dev/null

# Nettoyage des logs Apache
find /var/log/apache2 -name "*.log" -type f -mtime +$RETENTION_DAYS -exec rm -f {} \; 2>/dev/null

# Nettoyage des logs de sécurité
find /var/log -name "auth.log.*" -type f -mtime +$RETENTION_DAYS -exec rm -f {} \; 2>/dev/null
find /var/log -name "syslog.*" -type f -mtime +$RETENTION_DAYS -exec rm -f {} \; 2>/dev/null

# Anonymisation des adresses IP dans les logs récents
/usr/local/bin/anonymize-logs.sh

echo "$(date): Nettoyage RGPD terminé" >> $LOG_FILE

---

# roles/common/templates/ntp.conf.j2
# Configuration NTP pour synchronisation temporelle
driftfile /var/lib/ntp/ntp.drift
leapfile /usr/share/zoneinfo/leap-seconds.list

statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable

# Serveurs NTP français
server 0.fr.pool.ntp.org iburst
server 1.fr.pool.ntp.org iburst
server 2.fr.pool.ntp.org iburst
server 3.fr.pool.ntp.org iburst

# Serveurs de fallback
server 0.europe.pool.ntp.org iburst
server 1.europe.pool.ntp.org iburst

# Configuration de sécurité
restrict -4 default kod notrap nomodify nopeer noquery limited
restrict -6 default kod notrap nomodify nopeer noquery limited
restrict 127.0.0.1
restrict ::1
restrict source notrap nomodify noquery